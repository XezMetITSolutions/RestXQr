<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced RestXqR Debugger</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f8f9fa;
            padding: 20px;
            font-size: 14px;
        }

        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
        }

        .card-header {
            background: #343a40;
            color: white;
            font-weight: bold;
        }

        pre {
            background: #212529;
            color: #00ff9d;
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
        }

        .status-badge {
            font-size: 0.9em;
        }

        .missing-col {
            background-color: #ffebee;
            color: #c62828;
            font-weight: bold;
        }

        .present-col {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0">üõ†Ô∏è RestXqR System Debugger</h3>
                            <small class="text-muted">API: <span id="apiUrlDisplay">...</span></small>
                        </div>
                        <div class="d-flex gap-2">
                            <input type="text" id="apiUrl" class="form-control"
                                value="https://masapp-backend.onrender.com/api" style="width: 300px;">
                            <input type="text" id="restId" class="form-control"
                                value="37b0322a-e11f-4ef1-b108-83be310aaf4d" placeholder="Restaurant ID"
                                style="width: 300px;">
                            <button class="btn btn-primary" onclick="init()">Refresh All</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Left Column: Actions -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">‚ö° Quick Fixes</div>
                    <div class="card-body d-flex flex-column gap-2">
                        <button onclick="runFix('/debug/sync-db', 'POST')" class="btn btn-warning text-start">
                            <strong>1. Fix Orders Table</strong><br>
                            <small>Adds 'approved' column</small>
                        </button>
                        <button onclick="runFix('/debug/add-kitchen-station', 'POST')"
                            class="btn btn-warning text-start">
                            <strong>2. Fix Menu Items</strong><br>
                            <small>Adds 'kitchen_station' column</small>
                        </button>
                        <button onclick="runFix('/debug/fix-restaurants-schema', 'GET')"
                            class="btn btn-warning text-start">
                            <strong>3. Fix Restaurants Table</strong><br>
                            <small>Adds 'kitchen_stations', 'printer_config'</small>
                        </button>
                        <button onclick="runFix('/debug/add-discount-columns', 'GET')"
                            class="btn btn-warning text-start">
                            <strong>4. Fix Discount Columns</strong><br>
                            <small>Adds discount fields to menu/cats</small>
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">üì° API Tests</div>
                    <div class="card-body d-flex flex-column gap-2">
                        <button onclick="testApi('/health')" class="btn btn-outline-secondary">Check Health</button>
                        <button onclick="testApiMenu()" class="btn btn-outline-primary">Get Menu (Test 500
                            Error)</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">üìù Console Output</div>
                    <div class="card-body p-0">
                        <pre id="consoleOutput">Waiting...</pre>
                    </div>
                </div>
            </div>

            <!-- Right Column: Schema Status -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <span>üìä Database Schema Status</span>
                        <button class="btn btn-sm btn-light" onclick="checkSchema()">Refresh Schema</button>
                    </div>
                    <div class="card-body" id="schemaContainer">
                        <div class="text-center p-5">Loading schema info...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const getUrl = () => document.getElementById('apiUrl').value;
        const getRestId = () => document.getElementById('restId').value;
        const log = (msg, type = 'info') => {
            const el = document.getElementById('consoleOutput');
            const str = typeof msg === 'object' ? JSON.stringify(msg, null, 2) : msg;
            el.innerHTML = `<span class="${type === 'error' ? 'text-danger' : 'text-success'}">${new Date().toLocaleTimeString()} > ${str}</span>\n` + el.innerHTML;
        };

        function init() {
            document.getElementById('apiUrlDisplay').innerText = getUrl();
            checkSchema();
        }

        async function fetchAPI(endpoint, method = 'GET') {
            try {
                const res = await fetch(getUrl() + endpoint, { method });
                const text = await res.text();
                try {
                    return JSON.parse(text);
                } catch {
                    return { error: text };
                }
            } catch (e) {
                return { error: e.message };
            }
        }

        async function runFix(endpoint, method) {
            log(`Running fix: ${endpoint}...`);
            const res = await fetchAPI(endpoint, method);
            log(res, res.success ? 'info' : 'error');
            setTimeout(checkSchema, 1000); // Reload schema after fix
        }

        async function testApi(endpoint) {
            log(`Fetching ${endpoint}...`);
            const res = await fetchAPI(endpoint);
            log(res, res.success ? 'info' : 'error');
        }

        async function testApiMenu() {
            const id = getRestId();
            log(`Fetching menu for ${id}...`);
            const res = await fetchAPI(`/restaurants/${id}/menu`);
            log(res);
        }

        async function checkSchema() {
            const container = document.getElementById('schemaContainer');
            container.innerHTML = '<div class="text-center text-muted">Scanning database...</div>';

            const res = await fetchAPI('/debug/db-schema-info');

            if (!res.success) {
                container.innerHTML = `<div class="alert alert-danger">${res.error || 'Failed to fetch schema'}</div>`;
                return;
            }

            let html = '';

            // Expected columns mapping
            const expected = res.expected || {};

            Object.keys(res.schema).forEach(table => {
                const columns = res.schema[table];
                const tableExpected = expected[table] || [];

                // Calculate missing critical columns
                const missing = tableExpected.filter(exp =>
                    !columns.find(col => col.column_name === exp.name)
                );

                const statusColor = missing.length > 0 ? 'border-danger' : 'border-success';
                const headerColor = missing.length > 0 ? 'bg-danger text-white' : 'bg-light';

                html += `
                    <div class="card mb-3 border ${statusColor}">
                        <div class="card-header ${headerColor} py-1 px-3 d-flex justify-content-between align-items-center">
                            <span>${table.toUpperCase()} (${columns.length} columns)</span>
                            ${missing.length > 0 ? '<span class="badge bg-white text-danger">MISSING CRITICAL COLUMNS!</span>' : '<span class="badge bg-success">OK</span>'}
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 200px;">
                                <table class="table table-sm table-striped mb-0">
                                    <thead>
                                        <tr>
                                            <th>Column</th>
                                            <th>Type</th>
                                            <th>Nullable</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;

                // Show missing first
                missing.forEach(m => {
                    html += `
                        <tr class="missing-col">
                            <td>${m.name}</td>
                            <td>${m.type}</td>
                            <td>-</td>
                            <td>MISSING ‚ùå</td>
                        </tr>
                    `;
                });

                // Show existing
                columns.forEach(c => {
                    html += `
                        <tr>
                            <td>${c.column_name}</td>
                            <td>${c.data_type}</td>
                            <td>${c.is_nullable}</td>
                            <td>Present ‚úîÔ∏è</td>
                        </tr>
                    `;
                });

                html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Init on load
        init();
    </script>
</body>

</html>